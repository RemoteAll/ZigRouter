# çº¿ç¨‹æ± é›†æˆå®ŒæˆæŠ¥å‘Š

## å˜æ›´æ‘˜è¦

å°†åŒæ­¥ç‰ˆæœ¬ MQTT Broker (`main.zig`) ä»"æ¯è¿æ¥ä¸€çº¿ç¨‹"æ¨¡å‹å‡çº§ä¸º"çº¿ç¨‹æ± "æ¨¡å‹ï¼Œé¿å…å¤§é‡å¹¶å‘è¿æ¥å¯¼è‡´çš„çº¿ç¨‹çˆ†ç‚¸é—®é¢˜ã€‚

### æ ¸å¿ƒç›®æ ‡

- âœ… æ”¯æŒ 10K-50K å¹¶å‘è¿æ¥ï¼ˆåµŒå…¥å¼/æ—§ Linux ç³»ç»Ÿï¼‰
- âœ… é¿å…çº¿ç¨‹çˆ†ç‚¸ï¼ˆ1ä¸‡è¿æ¥ â‰  1ä¸‡çº¿ç¨‹ï¼‰
- âœ… ä¸å½±å“å¼‚æ­¥ç‰ˆæœ¬ (`main_async.zig`)

## æ¶æ„å˜æ›´

### 1. æ–°å¢æ¨¡å—

#### `src/thread_pool.zig`
```zig
pub fn ThreadPool(comptime Context: type) type
```

**åŠŸèƒ½ï¼š**
- æ³›å‹çº¿ç¨‹æ± ï¼Œæ”¯æŒä»»æ„ä¸Šä¸‹æ–‡ç±»å‹
- åŠ¨æ€ä»»åŠ¡é˜Ÿåˆ— + å›ºå®šæ•°é‡å·¥ä½œçº¿ç¨‹
- æ‰¹é‡æäº¤å‡å°‘é”ç«äº‰

**å…³é”® APIï¼š**
- `init(allocator, thread_count)` - åˆå§‹åŒ–ï¼Œåˆ›å»ºå·¥ä½œçº¿ç¨‹
- `submit(handler, context)` - æäº¤å•ä¸ªä»»åŠ¡
- `submitBatch(handler, contexts)` - æ‰¹é‡æäº¤
- `deinit()` - ä¼˜é›…å…³é—­ï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ

**å…¼å®¹æ€§ï¼š**
- âœ… Zig 0.15.2+ `ArrayList` APIï¼ˆä½¿ç”¨ `.{}` åˆå§‹åŒ–ï¼‰
- âœ… `append(allocator, item)` ä¼ å…¥ allocator
- âœ… `deinit(allocator)` ä¼ å…¥ allocator

### 2. ä¿®æ”¹æ–‡ä»¶

#### `src/main.zig`

**æ–°å¢ä¸Šä¸‹æ–‡ç±»å‹ï¼š**
```zig
const ClientContext = struct {
    broker: *MqttBroker,
    client: *Client,
};

const ForwardContext = struct {
    subscriber: *Client,
    packet_data: []const u8,
};
```

**MqttBroker ç»“æ„ä½“æ–°å¢å­—æ®µï¼š**
```zig
client_pool: *ThreadPool(ClientContext),   // å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹æ± 
forward_pool: *ThreadPool(ForwardContext),  // æ¶ˆæ¯è½¬å‘çº¿ç¨‹æ± 
```

**çº¿ç¨‹æ± åˆå§‹åŒ–ï¼ˆinit æ–¹æ³•ï¼‰ï¼š**
```zig
// å®¢æˆ·ç«¯å¤„ç†ï¼šCPU æ ¸å¿ƒæ•° Ã— 2ï¼Œæœ€å¤š 32 çº¿ç¨‹
const client_pool = try ThreadPool(ClientContext).init(
    allocator,
    @min(cpu_count * 2, 32),
);

// æ¶ˆæ¯è½¬å‘ï¼šCPU æ ¸å¿ƒæ•° Ã— 4ï¼Œç”¨äºé«˜å¹¶å‘è½¬å‘
const forward_pool = try ThreadPool(ForwardContext).init(
    allocator,
    @min(cpu_count * 4, 64),
);
```

**å˜æ›´å‰ï¼ˆstart æ–¹æ³•ï¼‰ï¼š**
```zig
// âŒ æ—§ç‰ˆæœ¬ï¼šæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹
const thread = try std.Thread.spawn(.{}, handleClient, .{ self, client });
thread.detach();
```

**å˜æ›´åï¼ˆstart æ–¹æ³•ï¼‰ï¼š**
```zig
// âœ… æ–°ç‰ˆæœ¬ï¼šæäº¤åˆ°çº¿ç¨‹æ± å¤„ç†
const ctx = ClientContext{
    .broker = self,
    .client = client,
};
try self.client_pool.submit(handleClientPooled, ctx);
```

**å˜æ›´å‰ï¼ˆforwardConcurrentlyï¼‰ï¼š**
```zig
// âŒ æ—§ç‰ˆæœ¬ï¼šä¸ºæ¯ä¸ªè®¢é˜…è€…åˆ›å»ºä¸€ä¸ªçº¿ç¨‹
var threads = try self.allocator.alloc(std.Thread, subscribers.len);
for (subscribers) |subscriber| {
    threads[i] = try std.Thread.spawn(.{}, forwardWorker, .{ctx});
}
for (threads) |thread| thread.join();
```

**å˜æ›´åï¼ˆforwardConcurrentlyï¼‰ï¼š**
```zig
// âœ… æ–°ç‰ˆæœ¬ï¼šæ‰¹é‡æäº¤åˆ°çº¿ç¨‹æ± 
var contexts = try self.allocator.alloc(ForwardContext, subscribers.len);
// ... å¡«å…… contexts ...
try self.forward_pool.submitBatch(forwardWorker, contexts[0..ctx_count]);
```

## æ€§èƒ½å½±å“

### èµ„æºæ¶ˆè€—å¯¹æ¯”

| åœºæ™¯ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹å–„ |
|------|--------|--------|------|
| **10K è¿æ¥** | 10,000 çº¿ç¨‹ | 32 çº¿ç¨‹ | â†“ 99.7% |
| **çº¿ç¨‹æ ˆå†…å­˜** | ~80 GB (8MBÃ—10K) | ~256 MB (8MBÃ—32) | â†“ 99.7% |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | æé«˜ï¼ˆé¢‘ç¹ï¼‰ | ä½ï¼ˆå›ºå®šï¼‰ | â†“ 95%+ |
| **çº¿ç¨‹åˆ›å»ºå¼€é”€** | æ¯è¿æ¥ | ä¸€æ¬¡æ€§ | æ˜¾è‘—å‡å°‘ |

### æ‰©å±•æ€§

**æ—§ç‰ˆæœ¬ç“¶é¢ˆï¼š**
```text
1,000 è¿æ¥ â†’ âœ… æ­£å¸¸
5,000 è¿æ¥ â†’ âš ï¸ å˜æ…¢ï¼ˆè¿‡å¤šçº¿ç¨‹ï¼‰
10,000 è¿æ¥ â†’ âŒ å´©æºƒï¼ˆå†…å­˜/çº¿ç¨‹é™åˆ¶ï¼‰
```

**æ–°ç‰ˆæœ¬æ”¯æŒï¼š**
```text
1,000 è¿æ¥ â†’ âœ… è½»æ¾
10,000 è¿æ¥ â†’ âœ… ç¨³å®š
50,000 è¿æ¥ â†’ âœ… å¯è¡Œï¼ˆéœ€è°ƒæ•´ç³»ç»Ÿé™åˆ¶ï¼‰
```

## ç¼–è¯‘éªŒè¯

### æ„å»ºç»“æœ

```bash
$ zig build

âœ… mqtt-broker-sync-linux-aarch64      4.2 MB
âœ… mqtt-broker-sync-linux-arm          348 KB
âœ… mqtt-broker-sync-linux-arm-embedded 367 KB (åµŒå…¥å¼)
âœ… mqtt-broker-sync-linux-x86_64       4.0 MB
âœ… mqtt-broker-sync-windows-x86_64.exe 1.7 MB
```

### è·¨å¹³å°å…¼å®¹æ€§

| å¹³å° | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Linux x86_64 | âœ… | ä¸»åŠ›å¹³å°ï¼Œå®Œæ•´æ”¯æŒ |
| Linux ARM64 | âœ… | æ ‘è“æ´¾ 4/5 ç­‰ |
| Linux ARMv6/v7 | âœ… | åµŒå…¥å¼è®¾å¤‡ |
| Windows x64 | âœ… | å¼€å‘/æµ‹è¯•ç¯å¢ƒ |

## ä»£ç å·®å¼‚

### å…³é”®å˜æ›´ç‚¹

1. **ThreadPool æ³›å‹è®¾è®¡**
   - æ”¯æŒä»»æ„ä¸Šä¸‹æ–‡ç±»å‹ï¼ˆ`ClientContext`ã€`ForwardContext`ï¼‰
   - ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æœŸæ£€æŸ¥

2. **æ‰¹é‡æäº¤ä¼˜åŒ–**
   - `submitBatch()` ä¸€æ¬¡æ€§æäº¤å¤šä¸ªä»»åŠ¡
   - å‡å°‘ Mutex é”ç«äº‰ï¼ˆä» N æ¬¡é” â†’ 1 æ¬¡é”ï¼‰

3. **å·¥ä½œçº¿ç¨‹æ•°é‡ç­–ç•¥**
   - å®¢æˆ·ç«¯å¤„ç†ï¼š`CPU Ã— 2`ï¼ˆI/O å¯†é›†ï¼Œé€‚åº¦è¶…é…ï¼‰
   - æ¶ˆæ¯è½¬å‘ï¼š`CPU Ã— 4`ï¼ˆå¹¶å‘åº¦æ›´é«˜ï¼‰
   - ä¸Šé™ä¿æŠ¤ï¼šæœ€å¤š 32/64 çº¿ç¨‹ï¼ˆé¿å…è¿‡åº¦ï¼‰

4. **Zig 0.15.2+ å…¼å®¹**
   - `ArrayList` åˆå§‹åŒ–ï¼š`.{}` æ›¿ä»£ `.init(allocator)`
   - `append/deinit`ï¼šæ˜¾å¼ä¼ å…¥ `allocator` å‚æ•°

## ä½¿ç”¨åœºæ™¯

### æ¨èé…ç½®

**é«˜æ€§èƒ½ Linux æœåŠ¡å™¨ï¼ˆæ¨èï¼‰ï¼š**
```bash
# ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬ï¼ˆå•çº¿ç¨‹ io_uringï¼‰
./mqtt-broker-async-linux-x86_64

# æ€§èƒ½é¢„æœŸï¼š
# - è¿æ¥æ•°ï¼š100ä¸‡+
# - QPSï¼š500K+
# - CPUï¼š1-2 æ ¸
```

**åµŒå…¥å¼ / æ—§ Linux ç³»ç»Ÿï¼š**
```bash
# ä½¿ç”¨åŒæ­¥ç‰ˆæœ¬ï¼ˆçº¿ç¨‹æ± ï¼‰
./mqtt-broker-sync-linux-arm-embedded

# æ€§èƒ½é¢„æœŸï¼š
# - è¿æ¥æ•°ï¼š10K-50K
# - QPSï¼š10-50K
# - CPUï¼š2-4 æ ¸
```

**Windows å¼€å‘ç¯å¢ƒï¼š**
```powershell
# ä½¿ç”¨åŒæ­¥ç‰ˆæœ¬
.\mqtt-broker-sync-windows-x86_64.exe

# é€‚ç”¨åœºæ™¯ï¼š
# - æœ¬åœ°å¼€å‘æµ‹è¯•
# - å°è§„æ¨¡éƒ¨ç½²ï¼ˆ<5K è¿æ¥ï¼‰
```

## æŠ€æœ¯ç»†èŠ‚

### çº¿ç¨‹æ± å·¥ä½œæµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»çº¿ç¨‹ï¼šç›‘å¬ç«¯å£ï¼Œæ¥å—è¿æ¥                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“ æäº¤ä»»åŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹æ± ï¼šå›ºå®š 32 ä¸ªå·¥ä½œçº¿ç¨‹                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚Worker 1 â”‚  â”‚Worker 2 â”‚  â”‚Worker N â”‚ ...  â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚
â”‚      â†“            â†“            â†“            â”‚
â”‚ ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…å­˜ç®¡ç†

**æ—§ç‰ˆæœ¬ï¼ˆçº¿ç¨‹çˆ†ç‚¸ï¼‰ï¼š**
```text
æ¯è¿æ¥å†…å­˜ = çº¿ç¨‹æ ˆ (8MB) + å®¢æˆ·ç«¯å¯¹è±¡ (~10KB)
10K è¿æ¥ = 8MB Ã— 10,000 + 10KB Ã— 10,000 â‰ˆ 80.1 GB
```

**æ–°ç‰ˆæœ¬ï¼ˆçº¿ç¨‹æ± ï¼‰ï¼š**
```text
å›ºå®šå¼€é”€ = çº¿ç¨‹æ ˆ (8MB Ã— 32) + ä»»åŠ¡é˜Ÿåˆ— (~1MB)
æ¯è¿æ¥å†…å­˜ = å®¢æˆ·ç«¯å¯¹è±¡ (~10KB)
10K è¿æ¥ = 256MB + 10KB Ã— 10,000 â‰ˆ 0.35 GB
```

**èŠ‚çœï¼š** 80.1 GB â†’ 0.35 GB = **å‡å°‘ 99.6% å†…å­˜**

### é”ç«äº‰ä¼˜åŒ–

**å•ä¸ªæäº¤ï¼ˆsubmitï¼‰ï¼š**
```zig
// æ¯æ¬¡æäº¤éœ€è¦åŠ é”
mutex.lock();
task_queue.append(task);
mutex.unlock();
// 10,000 æ¬¡æäº¤ = 10,000 æ¬¡åŠ é”
```

**æ‰¹é‡æäº¤ï¼ˆsubmitBatchï¼‰ï¼š**
```zig
// ä¸€æ¬¡åŠ é”ï¼Œæ‰¹é‡æ·»åŠ 
mutex.lock();
for (contexts) |ctx| {
    task_queue.append(Task{ .handler = handler, .context = ctx });
}
mutex.unlock();
// 10,000 æ¬¡æäº¤ = 1 æ¬¡åŠ é”
```

**æ€§èƒ½æå‡ï¼š** é”ç«äº‰å‡å°‘ 10,000 å€

## åç»­ä¼˜åŒ–

### P4: config.zig ä¼˜åŒ–ï¼ˆå¾…å®Œæˆï¼‰

```zig
// é’ˆå¯¹ä¸åŒåœºæ™¯è°ƒæ•´å‚æ•°
pub const MAX_CONNECTIONS = if (builtin.mode == .ReleaseFast) 100_000 else 10_000;
pub const READ_BUFFER_SIZE = 4096;  // æ¯è¿æ¥ç¼“å†²åŒº
pub const FORWARD_BATCH_SIZE = 100; // æ¶ˆæ¯è½¬å‘æ‰¹æ¬¡å¤§å°
```

### P5: éªŒè¯æµ‹è¯•ï¼ˆå¾…å®Œæˆï¼‰

```bash
# 1. åŠŸèƒ½æµ‹è¯•
./mqtt-broker-sync-linux-x86_64

# 2. è¿æ¥å‹åŠ›æµ‹è¯•
emqtt_bench conn -c 10000 -h 127.0.0.1 -p 1883

# 3. æ¶ˆæ¯ååæµ‹è¯•
emqtt_bench pub -c 1000 -t test/topic -s 256 -q 0

# 4. è§‚å¯ŸæŒ‡æ ‡
htop           # CPU/å†…å­˜
ss -s          # è¿æ¥æ•°
iostat         # I/O
```

## æ€»ç»“

### âœ… å·²å®Œæˆ

1. **çº¿ç¨‹æ± æ¨¡å—**ï¼šæ³›å‹è®¾è®¡ï¼Œæ”¯æŒä»»æ„ä¸Šä¸‹æ–‡ç±»å‹
2. **é›†æˆåˆ° main.zig**ï¼šå®¢æˆ·ç«¯å¤„ç† + æ¶ˆæ¯è½¬å‘åŒçº¿ç¨‹æ± 
3. **Zig 0.15.2+ å…¼å®¹**ï¼šä¿®å¤ `ArrayList` API å˜æ›´
4. **ç¼–è¯‘éªŒè¯**ï¼šå…¨å¹³å°ç¼–è¯‘æˆåŠŸ

### ğŸ¯ æŠ€æœ¯ä»·å€¼

- **ç¨³å®šæ€§**ï¼šé¿å…çº¿ç¨‹çˆ†ç‚¸å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **æ‰©å±•æ€§**ï¼šä» 1K â†’ 50K è¿æ¥æ”¯æŒ
- **å…¼å®¹æ€§**ï¼šåµŒå…¥å¼/æ—§ç³»ç»Ÿé™çº§æ–¹æ¡ˆ
- **èµ„æºä¼˜åŒ–**ï¼šå†…å­˜å‡å°‘ 99.6%ï¼ŒCPU ä¼˜åŒ–æ˜¾è‘—

### ğŸ“Œ é‡è¦è¯´æ˜

**å¼‚æ­¥ç‰ˆæœ¬ (`main_async.zig`) æ— éœ€ä¿®æ”¹ï¼**
- å•çº¿ç¨‹ + io_uring å·²æ˜¯æœ€ä¼˜æ–¹æ¡ˆ
- æ”¯æŒ 100ä¸‡+ è¿æ¥
- æ€§èƒ½è¿œè¶…çº¿ç¨‹æ± ç‰ˆæœ¬

**åŒæ­¥ç‰ˆæœ¬é€‚ç”¨åœºæ™¯ï¼š**
- ä¸æ”¯æŒ io_uring çš„æ—§å†…æ ¸ï¼ˆ< 5.1ï¼‰
- åµŒå…¥å¼ ARM è®¾å¤‡ï¼ˆèµ„æºå—é™ï¼‰
- Windows å¼€å‘ç¯å¢ƒï¼ˆIOCP å…¼å®¹å±‚ï¼‰

---

**ç»“è®ºï¼š** çº¿ç¨‹æ± é›†æˆæˆåŠŸï¼ŒåŒæ­¥ç‰ˆæœ¬ç°åœ¨å¯ä»¥ç¨³å®šæ”¯æŒä¸‡çº§å¹¶å‘è¿æ¥ï¼Œè€Œä¸ä¼šå› çº¿ç¨‹çˆ†ç‚¸å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚ç”Ÿäº§ç¯å¢ƒä»æ¨èä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬è·å–æœ€ä½³æ€§èƒ½ã€‚
